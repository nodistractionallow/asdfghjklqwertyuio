<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ball-by-Ball Simulation</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #1e1e1e; color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 960px; background: #2c2c2c; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        h1, h2, h3 { text-align: center; color: #ffcc00; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        h2 { font-size: 1.8em; margin-bottom: 15px; border-bottom: 2px solid #ffcc00; padding-bottom: 10px;}
        h3 { font-size: 1.4em; margin-bottom: 10px; color: #eee;}

        .section { margin-bottom: 20px; padding: 15px; background-color: #3a3a3a; border-radius: 8px; }
        .section p { margin: 8px 0; font-size: 1.1em; }
        .section strong { color: #ffcc00; }

        #led-display { text-align: center; padding: 20px; background-color: #111; border-radius: 8px; margin-bottom: 20px; font-size: 2em; display: flex; justify-content: space-around; align-items: center; }
        #led-display span { padding: 10px 20px; border-radius: 5px; background-color: #000; min-width: 100px; display: inline-block; }
        .led-runs-0 { background-color: #757575; color: #fff; }
        .led-runs-123 { background-color: #4CAF50; color: white; }
        .led-runs-456 { background-color: #FF9800; color: white; }
        .led-wicket { background-color: #F44336; color: white; }
        .led-extra { background-color: #2196F3; color: white; }

        .player-highlight { font-weight: bold; color: #ffeb3b; }

        .controls { display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
        .controls button, .controls select { padding: 10px 18px; font-size: 1em; cursor: pointer; background-color: #ffcc00; color: #1e1e1e; border: none; border-radius: 5px; transition: background-color 0.3s; }
        .controls button:hover { background-color: #e6b800; }
        .controls button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        .controls select { background-color: #4a4a4a; color: #fff; border: 1px solid #ffcc00; }

        #last-ball-commentary { font-size: 1.2em; text-align: center; min-height: 30px; padding: 10px; background-color: #4a4a4a; border-radius: 5px;}
        #full-innings-log { max-height: 200px; overflow-y: auto; padding: 10px; background-color: #222; border-radius: 5px; font-size: 0.9em; }
        .log-entry { border-bottom: 1px solid #444; padding: 6px 0; }
        .log-entry:last-child { border-bottom: none; }

        .win-message { text-align: center; font-size: 1.8em; color: #4CAF50; font-weight: bold; padding: 20px; background-color: #dff0d8; border: 1px solid #4CAF50; border-radius: 5px; color:#3c763d;}
        .error-message { color: #F44336; text-align: center; }
        .hidden { display: none; }
        #loadingIndicator { text-align: center; font-style: italic; margin-top:10px; color: #ffcc00;}
        a { color: #ffcc00; text-decoration: none; }
        a:hover { text-decoration: underline;}

        .team-logo-pbs { width: 30px; height: 30px; margin-right: 8px; vertical-align: middle; border-radius: 50%; background-color: #fff; padding:2px; }
        .team-display { display: flex; align-items: center; margin-bottom: 5px;}
        .team-display .name {font-size: 1.2em; font-weight:bold;}
        .team-display .score-details {font-size: 1.1em; margin-left:10px;}

    </style>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=337941,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>
</head>
<body>
    <div class="container">
        <div data-banner-id="6077667"></div>
        <h1>Live Cricket Simulation</h1>
        <p style="text-align:center;"><a href="{{ url_for('index') }}">New Match / Back to Team Selection</a></p>

        <div id="tossDisplay" class="section"></div>

        <div id="led-display">
            Ball: <span id="led-ball-number">0.0</span> |
            Outcome: <span id="led-ball-outcome">---</span> |
            Score: <span id="led-current-total">0/0</span>
        </div>

        <div class="section score-info">
            <h2>Scoreboard</h2>
            <div class="team-display batting-team-display">
                <img src="" alt="Batting Team Logo" class="team-logo-pbs" id="battingTeamLogo">
                <div>
                    <span class="name" id="battingTeamName">N/A</span>
                    <span class="score-details">Score: <span id="currentScore">0</span>/<span id="currentWickets">0</span> (<span id="currentOvers">0.0</span> Overs)</span>
                </div>
            </div>
            <div class="team-display bowling-team-display" style="margin-top:10px;">
                <img src="" alt="Bowling Team Logo" class="team-logo-pbs" id="bowlingTeamLogo">
                 <span class="name" id="bowlingTeamName">N/A</span>
            </div>
            <div id="targetInfo" class="hidden" style="margin-top:15px;">
                <p><strong>Target:</strong> <span id="targetScore">0</span></p>
                <p><strong>Needed:</strong> <span id="runsNeeded">0</span> runs from <span id="ballsRemaining">0</span> balls</p>
            </div>
        </div>

        <div class="section players-info">
            <h3>Players</h3>
            <p>On Strike: <span id="batsman-onstrike" class="player-highlight">N/A</span></p>
            <p>Non-Striker: <span id="batsman-nonstrike">N/A</span></p>
            <p>Current Bowler: <span id="current-bowler">N/A</span></p>
        </div>

        <div id="winMessageContainer" class="win-message hidden"></div>

        <div class="controls section">
            <button id="simulateNextBallBtn">Simulate Next Ball</button>
            <select id="simSpeed">
                <option value="3000">Slow (3s)</option>
                <option value="2000">Medium (2s)</option>
                <option value="1000" selected>Fast (1s)</option>
                <option value="500">Very Fast (0.5s)</option>
                <option value="100">Instant (0.1s)</option>
            </select>
            <button id="startAutoPlayBtn">Start Auto-Play</button>
            <button id="pauseAutoPlayBtn" class="hidden">Pause Auto-Play</button>
        </div>
        <div id="loadingIndicator" class="hidden">Simulating...</div>

        <div class="section commentary-box">
            <h3>Last Ball Commentary</h3>
            <div id="last-ball-commentary">Waiting for first ball...</div>
        </div>

        <div class="section full-log-box">
            <h3>Full Innings Log</h3>
            <div id="full-innings-log"></div>
        </div>
    </div>

    <script>
        const tossDisplayEl = document.getElementById('tossDisplay');
        const ledBallNumEl = document.getElementById('led-ball-number');
        const ledOutcomeEl = document.getElementById('led-ball-outcome');
        const ledScoreEl = document.getElementById('led-current-total');

        const battingTeamNameEl = document.getElementById('battingTeamName');
        const battingTeamLogoEl = document.getElementById('battingTeamLogo'); // New
        const currentScoreEl = document.getElementById('currentScore');
        const currentWicketsEl = document.getElementById('currentWickets');
        const currentOversEl = document.getElementById('currentOvers');

        const bowlingTeamNameEl = document.getElementById('bowlingTeamName');
        const bowlingTeamLogoEl = document.getElementById('bowlingTeamLogo'); // New

        const targetInfoEl = document.getElementById('targetInfo');
        const targetScoreEl = document.getElementById('targetScore');
        const runsNeededEl = document.getElementById('runsNeeded');
        const ballsRemainingEl = document.getElementById('ballsRemaining');

        const onStrikeBatsmanEl = document.getElementById('batsman-onstrike');
        const nonStrikeBatsmanEl = document.getElementById('batsman-nonstrike');
        const currentBowlerEl = document.getElementById('current-bowler');

        const winMessageContainerEl = document.getElementById('winMessageContainer');
        const simulateNextBallBtn = document.getElementById('simulateNextBallBtn');
        const simSpeedSelect = document.getElementById('simSpeed');
        const startAutoPlayBtn = document.getElementById('startAutoPlayBtn');
        const pauseAutoPlayBtn = document.getElementById('pauseAutoPlayBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const lastBallCommentaryEl = document.getElementById('last-ball-commentary');
        const fullInningsLogEl = document.getElementById('full-innings-log');

        let autoPlayInterval = null;
        let currentInningsLogNumber = 0;

        function formatOver(legalBalls) {
            if (legalBalls === undefined || legalBalls === null || legalBalls < 0) return "0.0";
            const overs = Math.floor(legalBalls / 6);
            const ballsInOver = legalBalls % 6;
            return `${overs}.${ballsInOver}`;
        }

        function updateUI(gameState, ballEvent) {
            if (!gameState) return;

            tossDisplayEl.textContent = gameState.toss_message;

            // Update team names and logos
            const currentBattingTeamCode = gameState.current_batting_team;
            const currentBowlingTeamCode = gameState.current_bowling_team;

            battingTeamNameEl.textContent = currentBattingTeamCode || 'N/A';
            bowlingTeamNameEl.textContent = currentBowlingTeamCode || 'N/A';

            // Set logos based on which team (team1_code or team2_code from gameState) is currently batting/bowling
            if (currentBattingTeamCode === gameState.team1_code) {
                battingTeamLogoEl.src = gameState.team1_logo || '';
                battingTeamLogoEl.alt = gameState.team1_code + ' Logo';
                bowlingTeamLogoEl.src = gameState.team2_logo || '';
                bowlingTeamLogoEl.alt = gameState.team2_code + ' Logo';
            } else if (currentBattingTeamCode === gameState.team2_code) {
                battingTeamLogoEl.src = gameState.team2_logo || '';
                battingTeamLogoEl.alt = gameState.team2_code + ' Logo';
                bowlingTeamLogoEl.src = gameState.team1_logo || '';
                bowlingTeamLogoEl.alt = gameState.team1_code + ' Logo';
            } else { // Before toss or if codes are missing
                battingTeamLogoEl.src = ''; battingTeamLogoEl.alt = 'Batting Team Logo';
                bowlingTeamLogoEl.src = ''; bowlingTeamLogoEl.alt = 'Bowling Team Logo';
            }

            const currentInningsNum = gameState.current_innings_num;
            const inningsData = gameState.innings_data[currentInningsNum];

            if (inningsData) {
                currentScoreEl.textContent = inningsData.score;
                currentWicketsEl.textContent = inningsData.wickets;
                currentOversEl.textContent = formatOver(inningsData.legal_balls_bowled);

                ledScoreEl.textContent = `${inningsData.score}/${inningsData.wickets}`;
                ledBallNumEl.textContent = formatOver(inningsData.legal_balls_bowled);

                if (currentInningsNum === 2 && gameState.target_score > 0) {
                    targetInfoEl.classList.remove('hidden');
                    targetScoreEl.textContent = gameState.target_score;
                    const needed = Math.max(0, gameState.target_score - inningsData.score);
                    const remainingBalls = Math.max(0, 120 - inningsData.legal_balls_bowled);
                    runsNeededEl.textContent = needed;
                    ballsRemainingEl.textContent = remainingBalls;
                } else {
                    targetInfoEl.classList.add('hidden');
                }
            }

            onStrikeBatsmanEl.textContent = gameState.on_strike || 'N/A';
            nonStrikeBatsmanEl.textContent = gameState.non_strike || 'N/A';
            currentBowlerEl.textContent = gameState.current_bowler || 'N/A';

            if (ballEvent && ballEvent.commentary_text) { // Changed from ballEvent.commentary
                let outcomeClass = 'led-runs-0';
                let outcomeText = String(ballEvent.runs_scored); // Use runs_scored from ball_event
                if (ballEvent.is_wicket) { outcomeClass = 'led-wicket'; outcomeText = "WICKET!"; }
                else if (ballEvent.extra_type) { outcomeClass = 'led-extra'; outcomeText = ballEvent.extra_type.toUpperCase(); }
                else if (ballEvent.runs_scored >= 4) { outcomeClass = 'led-runs-456'; }
                else if (ballEvent.runs_scored > 0) { outcomeClass = 'led-runs-123'; }

                ledOutcomeEl.textContent = outcomeText;
                ledOutcomeEl.className = outcomeClass;

                lastBallCommentaryEl.textContent = ballEvent.commentary_text; // Use commentary_text

                if(currentInningsLogNumber !== currentInningsNum){
                    fullInningsLogEl.innerHTML = '';
                    currentInningsLogNumber = currentInningsNum;
                }
                const logEntry = document.createElement('div');
                logEntry.classList.add('log-entry');
                // Using new keys from ball_log_entry in MatchSimulator
                logEntry.innerHTML = `<strong>${ballEvent.over_str} (${ballEvent.bowler_initial} to ${ballEvent.batsman_initial})</strong>: ${ballEvent.total_runs_ball} run(s). ${ballEvent.commentary_text}`;
                fullInningsLogEl.appendChild(logEntry);
                fullInningsLogEl.scrollTop = fullInningsLogEl.scrollHeight;
            } else if (!ballEvent && inningsData && inningsData.log && inningsData.log.length > 0) {
                // If no specific ball event (e.g. on initial load after rehydration), show last logged ball.
                const lastLoggedBall = inningsData.log[inningsData.log.length -1];
                 lastBallCommentaryEl.textContent = lastLoggedBall.commentary_text;
            } else {
                 ledOutcomeEl.textContent = "---";
                 ledOutcomeEl.className = "";
                 lastBallCommentaryEl.textContent = "Match Begins!";
            }

            if (gameState.game_over) {
                winMessageContainerEl.textContent = gameState.win_message;
                winMessageContainerEl.classList.remove('hidden');
                simulateNextBallBtn.disabled = true;
                startAutoPlayBtn.disabled = true;
                pauseAutoPlayBtn.classList.add('hidden');
                if (autoPlayInterval) clearInterval(autoPlayInterval);
            } else {
                simulateNextBallBtn.disabled = false;
                startAutoPlayBtn.disabled = false;
                winMessageContainerEl.classList.add('hidden');
            }
        }

        const initialGameState = {{ game_state | tojson }};
        currentInningsLogNumber = initialGameState.current_innings_num || 1; // Ensure it's at least 1
        updateUI(initialGameState, null);

        async function handleSimulateNextBall() {
            simulateNextBallBtn.disabled = true;
            if(!autoPlayInterval) loadingIndicator.classList.remove('hidden');
            lastBallCommentaryEl.textContent = "Simulating...";

            try {
                const response = await fetch("{{ url_for('simulate_next_ball') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // Expects {'summary': gameState, 'ball_event': ballEvent}
                updateUI(data.summary, data.ball_event);

                if (data.summary.game_over && autoPlayInterval) {
                    clearInterval(autoPlayInterval); autoPlayInterval = null;
                    pauseAutoPlayBtn.classList.add('hidden');
                    startAutoPlayBtn.classList.remove('hidden');
                    startAutoPlayBtn.disabled = true;
                    simSpeedSelect.disabled = false;
                }

            } catch (error) {
                console.error('Error simulating next ball:', error);
                lastBallCommentaryEl.textContent = `Error: ${error.message}`;
                if (autoPlayInterval) {
                    clearInterval(autoPlayInterval); autoPlayInterval = null;
                    pauseAutoPlayBtn.classList.add('hidden');
                    startAutoPlayBtn.classList.remove('hidden');
                    simSpeedSelect.disabled = false;
                }
            } finally {
                // Re-enable button only if game not over and not in autoplay
                if (!winMessageContainerEl.classList.contains('hidden')) { // Game is over
                    simulateNextBallBtn.disabled = true;
                } else if (!autoPlayInterval) { // Not in autoplay and game not over
                     simulateNextBallBtn.disabled = false;
                }
                if(!autoPlayInterval) loadingIndicator.classList.add('hidden');
            }
        }

        simulateNextBallBtn.addEventListener('click', handleSimulateNextBall);

        startAutoPlayBtn.addEventListener('click', () => {
            if (initialGameState.game_over) return; // Don't start if game already over
            startAutoPlayBtn.classList.add('hidden');
            pauseAutoPlayBtn.classList.remove('hidden');
            simulateNextBallBtn.disabled = true;
            simSpeedSelect.disabled = true;

            const speed = parseInt(simSpeedSelect.value, 10);
            handleSimulateNextBall();
            if (!document.getElementById('winMessageContainer').classList.contains('hidden')) return; // Don't start interval if game ended on first click
            autoPlayInterval = setInterval(handleSimulateNextBall, speed);
        });

        pauseAutoPlayBtn.addEventListener('click', () => {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
            pauseAutoPlayBtn.classList.add('hidden');
            startAutoPlayBtn.classList.remove('hidden');
            if (!winMessageContainerEl.classList.contains('hidden')) {
                 simulateNextBallBtn.disabled = true;
                 startAutoPlayBtn.disabled = true;
            } else {
                 simulateNextBallBtn.disabled = false;
                 startAutoPlayBtn.disabled = false;
            }
            simSpeedSelect.disabled = false;
        });

    </script>
</body>
</html>
